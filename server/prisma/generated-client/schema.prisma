generator client {
  provider = "prisma-client-js"
  output   = "./generated-client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─── ENUMS ───────────────────────────────────────────────────

enum Role {
  OWNER
  BRANCH_MANAGER
  SALES
  OPERATIONS
  KITCHEN
}

enum LeadStatus {
  CALL
  VISIT
  NEGOTIATION
  WON
  LOST
}

enum BookingStatus {
  TENTATIVE
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum EventStatus {
  UPCOMING
  ONGOING
  COMPLETED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CHEQUE
  UPI
  TRANSFER
  CARD
}

enum PaymentType {
  ADVANCE
  PARTIAL
  FINAL
  REFUND
}

enum StockMovementType {
  PURCHASE
  DEDUCTION
  ADJUSTMENT
  RETURN
}

enum PurchaseOrderStatus {
  DRAFT
  ORDERED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

enum ChecklistItemStatus {
  PENDING
  IN_PROGRESS
  DONE
}

enum ResourceCategory {
  STAFF
  FURNITURE
  FOOD
  OTHER
}

// ─── ORGANIZATION ────────────────────────────────────────────

model Branch {
  id        String   @id @default(cuid())
  name      String
  address   String
  city      String
  phone     String
  email     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users          User[]
  halls          Hall[]
  leads          Lead[]
  bookings       Booking[]
  events         Event[]
  invoices       Invoice[]
  inventoryItems InventoryItem[]
  purchaseOrders PurchaseOrder[]
  menuItems      MenuItem[]
  vendors        Vendor[]
  reviews        Review[]
  sentiments     BranchSentiment[]

  @@map("branches")
}

model Review {
  id         String   @id @default(cuid())
  reviewText String   @map("review_text")
  rating     Int
  createdAt  DateTime @default(now())
  branchId   String
  branch     Branch   @relation(fields: [branchId], references: [id])

  @@index([branchId])
  @@map("reviews")
}

model BranchSentiment {
  id             String   @id @default(cuid())
  sentimentScore Float    @map("sentiment_score")
  analyzedAt     DateTime @default(now()) @map("analyzed_at")
  branchId       String
  branch         Branch   @relation(fields: [branchId], references: [id])

  @@index([branchId])
  @@map("branch_sentiments")
}

model User {
  id        String   @id @default(cuid())
  authId    String   @unique
  email     String   @unique
  name      String
  phone     String?
  role      Role     @default(SALES)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  branchId  String?
  branch    Branch?  @relation(fields: [branchId], references: [id])

  // Relations
  createdBookings Booking[]      @relation("CreatedBookings")
  leadActivities  LeadActivity[]
  assignedLeads   Lead[]         @relation("AssignedLeads")
  createdLeads    Lead[]         @relation("CreatedLeads")
  payments        Payment[]

  @@index([branchId])
  @@index([role])
  @@map("users")
}

// ─── HALLS / VENUES ──────────────────────────────────────────

model Hall {
  id            String   @id @default(cuid())
  name          String
  capacity      Int
  pricePerEvent Float
  amenities     String[]
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  branchId      String
  branch        Branch   @relation(fields: [branchId], references: [id])

  bookings Booking[]

  @@index([branchId])
  @@map("halls")
}

// ─── LEAD MANAGEMENT ─────────────────────────────────────────

model Lead {
  id            String     @id @default(cuid())
  customerName  String
  customerPhone String
  customerEmail String?
  eventType     String
  eventDate     DateTime?
  guestCount    Int?
  status        LeadStatus @default(CALL)
  source        String?
  notes         String?
  lostReason    String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  branchId      String
  assignedToId  String
  createdById   String

  branch     Branch         @relation(fields: [branchId], references: [id])
  assignedTo User           @relation("AssignedLeads", fields: [assignedToId], references: [id])
  createdBy  User           @relation("CreatedLeads", fields: [createdById], references: [id])
  booking    Booking?
  activities LeadActivity[]

  @@index([branchId, status])
  @@index([branchId, assignedToId])
  @@map("leads")
}

model LeadActivity {
  id        String   @id @default(cuid())
  action    String
  details   String?
  createdAt DateTime @default(now())
  leadId    String
  userId    String

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@map("lead_activities")
}

// ─── BOOKINGS ────────────────────────────────────────────────

model Booking {
  id            String        @id @default(cuid())
  bookingNumber String        @unique
  startDate     DateTime
  endDate       DateTime
  startTime     String
  endTime       String
  guestCount    Int
  status        BookingStatus @default(TENTATIVE)
  totalAmount   Float
  advanceAmount Float         @default(0)
  balanceAmount Float
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  branchId    String
  hallId      String
  leadId      String @unique
  createdById String

  branch    Branch @relation(fields: [branchId], references: [id])
  hall      Hall   @relation(fields: [hallId], references: [id])
  lead      Lead   @relation(fields: [leadId], references: [id])
  createdBy User   @relation("CreatedBookings", fields: [createdById], references: [id])

  event            Event?
  invoice          Invoice?
  bookingResources BookingResource[]

  @@index([branchId, hallId, startDate, endDate])
  @@map("bookings")
}

// ─── EVENTS ──────────────────────────────────────────────────

model Event {
  id         String      @id @default(cuid())
  eventDate  DateTime
  guestCount Int
  status     EventStatus @default(UPCOMING)
  notes      String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  branchId  String
  bookingId String  @unique
  branch    Branch  @relation(fields: [branchId], references: [id])
  booking   Booking @relation(fields: [bookingId], references: [id])

  checklist      EventChecklist[]
  vendors        EventVendor[]
  menuItems      EventMenuItem[]
  stockMovements StockMovement[]

  @@map("events")
}

model EventMenuItem {
  id       String  @id @default(cuid())
  quantity Int // number of servings/plates
  notes    String?

  eventId    String
  menuItemId String
  event      Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])

  @@unique([eventId, menuItemId])
  @@map("event_menu_items")
}

model EventVendor {
  id      String  @id @default(cuid())
  service String
  cost    Float
  notes   String?

  eventId  String
  vendorId String
  event    Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  @@map("event_vendors")
}

model EventChecklist {
  id          String              @id @default(cuid())
  task        String
  status      ChecklistItemStatus @default(PENDING)
  dueDate     DateTime?
  completedAt DateTime?
  eventId     String
  event       Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_checklists")
}

// ─── INVENTORY \u0026 MENU ──────────────────────────────────────

model MenuItem {
  id            String  @id @default(cuid())
  name          String
  category      String
  pricePerPlate Float
  isVeg         Boolean @default(true)
  isActive      Boolean @default(true)
  branchId      String
  branch        Branch  @relation(fields: [branchId], references: [id])

  ingredients       MenuItemIngredient[]
  eventMenuItems    EventMenuItem[]
  menuItemResources MenuItemResource[]

  @@index([branchId])
  @@map("menu_items")
}

model MenuItemIngredient {
  id                 String @id @default(cuid())
  quantityPerServing Float
  unit               String

  menuItemId      String
  inventoryItemId String
  menuItem        MenuItem      @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])

  @@unique([menuItemId, inventoryItemId])
  @@map("menu_item_ingredients")
}

model InventoryItem {
  id            String  @id @default(cuid())
  name          String
  category      String
  unit          String
  currentStock  Float   @default(0)
  minStockLevel Float   @default(0)
  costPerUnit   Float   @default(0)
  isActive      Boolean @default(true)
  branchId      String
  branch        Branch  @relation(fields: [branchId], references: [id])

  menuItemIngredients MenuItemIngredient[]
  purchaseOrderItems  PurchaseOrderItem[]
  stockMovements      StockMovement[]

  @@index([branchId, currentStock])
  @@map("inventory_items")
}

model StockMovement {
  id              String            @id @default(cuid())
  type            StockMovementType
  quantity        Float
  notes           String?
  createdAt       DateTime          @default(now())
  inventoryItemId String
  eventId         String?

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])
  event         Event?        @relation(fields: [eventId], references: [id])

  @@index([inventoryItemId, createdAt])
  @@map("stock_movements")
}

model Vendor {
  id       String  @id @default(cuid())
  name     String
  service  String
  phone    String
  email    String?
  address  String?
  isActive Boolean @default(true)
  branchId String
  branch   Branch  @relation(fields: [branchId], references: [id])

  eventVendors   EventVendor[]
  purchaseOrders PurchaseOrder[]

  @@index([branchId])
  @@map("vendors")
}

// ─── PURCHASE ORDERS ─────────────────────────────────────────

model PurchaseOrder {
  id          String              @id @default(cuid())
  orderNumber String              @unique
  status      PurchaseOrderStatus @default(DRAFT)
  totalAmount Float               @default(0)
  notes       String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  branchId String
  vendorId String
  branch   Branch @relation(fields: [branchId], references: [id])
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  items PurchaseOrderItem[]

  @@index([branchId])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id               String @id @default(cuid())
  quantity         Float
  unitPrice        Float
  receivedQuantity Float  @default(0)
  purchaseOrderId  String
  inventoryItemId  String

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])

  @@map("purchase_order_items")
}

// ─── BILLING \u0026 PAYMENTS ──────────────────────────────────────

model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique
  subtotal      Float
  taxAmount     Float
  totalAmount   Float
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  branchId  String
  bookingId String  @unique
  branch    Branch  @relation(fields: [branchId], references: [id])
  booking   Booking @relation(fields: [bookingId], references: [id])

  payments Payment[]

  @@index([branchId])
  @@map("invoices")
}

model Payment {
  id          String        @id @default(cuid())
  amount      Float
  method      PaymentMethod
  type        PaymentType
  referenceNo String?
  notes       String?
  paidAt      DateTime      @default(now())
  createdAt   DateTime      @default(now())

  invoiceId    String
  receivedById String
  invoice      Invoice @relation(fields: [invoiceId], references: [id])
  receivedBy   User    @relation(fields: [receivedById], references: [id])

  @@index([invoiceId])
  @@map("payments")
}

// ─── RESOURCE PLANNING ───────────────────────────────────────

model Resource {
  id       String           @id @default(cuid())
  name     String
  category ResourceCategory
  unit     String

  menuItemResources MenuItemResource[]
  bookingResources  BookingResource[]

  @@unique([name, category])
  @@map("resources")
}

model MenuItemResource {
  id               String @id @default(cuid())
  quantityPerGuest Float

  menuItemId String
  resourceId String
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  resource   Resource @relation(fields: [resourceId], references: [id])

  @@unique([menuItemId, resourceId])
  @@map("menu_item_resources")
}

model BookingResource {
  id               String           @id @default(cuid())
  calculatedQty    Float
  manualQty        Float?
  isManuallyEdited Boolean          @default(false)
  category         ResourceCategory

  bookingId  String
  resourceId String
  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  resource   Resource @relation(fields: [resourceId], references: [id])

  @@unique([bookingId, resourceId])
  @@index([bookingId])
  @@map("booking_resources")
}
